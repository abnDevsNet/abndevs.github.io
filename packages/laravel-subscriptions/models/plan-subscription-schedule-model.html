<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plan Subscription Schedule | abnDevs</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="Build your dreams together">
    <meta name="theme-color" content="#0000FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.73d0500b.css" as="style"><link rel="preload" href="/assets/js/app.85871902.js" as="script"><link rel="preload" href="/assets/js/2.980f3844.js" as="script"><link rel="preload" href="/assets/js/21.71538835.js" as="script"><link rel="preload" href="/assets/js/3.9f4e4011.js" as="script"><link rel="prefetch" href="/assets/js/10.8b472593.js"><link rel="prefetch" href="/assets/js/11.47ab165f.js"><link rel="prefetch" href="/assets/js/12.94bb1235.js"><link rel="prefetch" href="/assets/js/13.b3e1e4f6.js"><link rel="prefetch" href="/assets/js/14.a6cd3dd4.js"><link rel="prefetch" href="/assets/js/15.4246eba7.js"><link rel="prefetch" href="/assets/js/16.65be3852.js"><link rel="prefetch" href="/assets/js/17.b368e2aa.js"><link rel="prefetch" href="/assets/js/18.46d72abf.js"><link rel="prefetch" href="/assets/js/19.332f0be1.js"><link rel="prefetch" href="/assets/js/20.8e43fa3c.js"><link rel="prefetch" href="/assets/js/22.71122ebd.js"><link rel="prefetch" href="/assets/js/23.0725ad15.js"><link rel="prefetch" href="/assets/js/24.366a61b0.js"><link rel="prefetch" href="/assets/js/25.3f7aaeea.js"><link rel="prefetch" href="/assets/js/4.7364160c.js"><link rel="prefetch" href="/assets/js/5.3da2d6a2.js"><link rel="prefetch" href="/assets/js/6.4d41e4ec.js"><link rel="prefetch" href="/assets/js/7.de19c5e4.js"><link rel="prefetch" href="/assets/js/8.38012b49.js"><link rel="prefetch" href="/assets/js/9.5aafaaea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.73d0500b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">abnDevs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/packages/" class="nav-link router-link-active">
  Packages
</a></div> <a href="https://github.com/abnDevs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="/packages/" class="nav-link router-link-active">
  Packages
</a></div> <a href="https://github.com/abnDevs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Laravel Subscriptions</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/packages/laravel-subscriptions/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/packages/laravel-subscriptions/install/" class="sidebar-link">Installation</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Models</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/packages/laravel-subscriptions/models/" aria-current="page" class="sidebar-link">Models</a></li><li><a href="/packages/laravel-subscriptions/models/plan-model.html" class="sidebar-link">Plan Model</a></li><li><a href="/packages/laravel-subscriptions/models/plan-combination-model.html" class="sidebar-link">Plan Combination Model</a></li><li><a href="/packages/laravel-subscriptions/models/plan-feature-model.html" class="sidebar-link">Plan Feature Model</a></li><li><a href="/packages/laravel-subscriptions/models/plan-subscription-model.html" class="sidebar-link">Plan Subscription Model</a></li><li><a href="/packages/laravel-subscriptions/models/plan-subscription-feature-model.html" class="sidebar-link">Plan Subscription Feature Model</a></li><li><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html" aria-current="page" class="active sidebar-link">Plan Subscription Schedule Model</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#what-it-does" class="sidebar-link">What it does</a></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#create-schedule" class="sidebar-link">Create schedule</a></li></ul></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#scopes" class="sidebar-link">Scopes</a></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#latest-and-first-schedule-to-date" class="sidebar-link">Latest and first schedule to date</a></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#service" class="sidebar-link">Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#how-to-make-a-service" class="sidebar-link">How to make a service?</a></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#service-options" class="sidebar-link">Service options</a></li></ul></li><li class="sidebar-sub-header"><a href="/packages/laravel-subscriptions/models/plan-subscription-schedule-model.html#dispatch-the-schedule-job" class="sidebar-link">Dispatch the schedule job</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Payments</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/packages/laravel-subscriptions/payments/payment-services.html" class="sidebar-link">Payment services</a></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Jobs</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/packages/laravel-subscriptions/payments/jobs/subscription-payment-queuer-job.html" class="sidebar-link">Subscription Payment Queuer</a></li><li><a href="/packages/laravel-subscriptions/payments/jobs/subscription-renewal-payment-job.html" class="sidebar-link">Subscription Payment</a></li><li><a href="/packages/laravel-subscriptions/payments/jobs/subscription-schedule-payment-job.html" class="sidebar-link">Subscription Schedule Payment</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="plan-subscription-schedule"><a href="#plan-subscription-schedule" class="header-anchor">#</a> Plan Subscription Schedule</h1> <p></p><div class="table-of-contents"><ul><li><a href="#what-it-does">What it does</a></li><li><a href="#usage">Usage</a><ul><li><a href="#create-schedule-badge-text-updated-in-v6-0-type-warning">Create schedule <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>updated in v6.0</span></a></li></ul></li><li><a href="#scopes">Scopes</a></li><li><a href="#latest-and-first-schedule-to-date">Latest and first schedule to date</a></li><li><a href="#service-badge-text-updated-in-v6-0-type-warning">Service <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>updated in v6.0</span></a><ul><li><a href="#how-to-make-a-service">How to make a service?</a></li><li><a href="#service-options">Service options</a></li></ul></li><li><a href="#dispatch-the-schedule-job">Dispatch the schedule job</a></li></ul></div><p></p> <p>Want to change a subscription but not right now? Schedule it at the end of the period? With this model you can
schedule your subscription plan changes.</p> <h2 id="what-it-does"><a href="#what-it-does" class="header-anchor">#</a> What it does</h2> <ul><li>Plan Subscription is scheduled to change to another plan or plan combination at a certain date in the future.
<ul><li>In this schedule you specify date and which service will be executed before the change.</li> <li>You can also set a timeout and tries for the job.</li></ul></li> <li>A job is added in your app schedule</li> <li>When the time comes, job batches all pending schedules and dispatches it.
<ul><li>Job will execute your defined service before plan change, if it succeeds, change will be done. If it fails,
schedule will be flagged as failed.</li></ul></li></ul> <h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <h3 id="create-schedule"><a href="#create-schedule" class="header-anchor">#</a> Create schedule <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>updated in v6.0</span></h3> <div class="custom-block danger"><p class="custom-block-title">Breaking change in v6.0</p> <p>Method <code>usingService</code> is abandoned to use subscription's payment method.</p></div> <p>You can schedule a change in your user subscription like this:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$date</span> <span class="token operator">=</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$proPlan</span> <span class="token operator">=</span> <span class="token class-name static-context">Plan</span><span class="token operator">::</span><span class="token function">findByTag</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pro-plan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toPlan</span><span class="token punctuation">(</span><span class="token variable">$proPlan</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">onDate</span><span class="token punctuation">(</span><span class="token variable">$date</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="scopes"><a href="#scopes" class="header-anchor">#</a> Scopes</h2> <p>These are the scopes you can apply to your <code>PlanSubscriptionSchedule</code> model.</p> <p><code>unprocessed()</code> returns all unprocessed schedules (not having success or failure) in the past and in the future.</p> <p><code>pending()</code> returns a list of schedules that have not been processed and are due to be processed. To define an ending
date, use <code>Carbon</code> date as parameter to show pending until specified date. Default returns pending until now.</p> <h2 id="latest-and-first-schedule-to-date"><a href="#latest-and-first-schedule-to-date" class="header-anchor">#</a> Latest and first schedule to date</h2> <p>With this functions you can retrieve your latest schedule to date, or your next upcoming schedule. Both return <code>null</code> if
there are no schedules.</p> <p>This is useful in case you want to always edit the latest schedule and not create new ones.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getLatestSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get latest schedule before date (now() or parameter with date)</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getFirstSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get first schedule after date (now() or parameter with date)</span>
</code></pre></div><h2 id="service"><a href="#service" class="header-anchor">#</a> Service <span class="badge warning" style="vertical-align:top;" data-v-15b7b770>updated in v6.0</span></h2> <div class="custom-block danger"><p class="custom-block-title">Breaking change in v6.0</p> <p>There are no longer multiple services to process the schedule. There is only one and it uses payments set via config.</p></div> <p>By default, the config file includes a service for processing your plan change. This service it's a good
starting point to see how it works. The service is a template service that will use payment method and do the plan change.</p> <h3 id="how-to-make-a-service"><a href="#how-to-make-a-service" class="header-anchor">#</a> How to make a service?</h3> <p>In the <code>ScheduleService</code> you can see the minimum requirements of a service.</p> <p>Your own service has to implement interface <code>PlanSubscriptionScheduleService</code>. <code>__construct</code> accepts one parameter, the
<code>PlanSubscriptionSchedule</code> Eloquent object of the subscription schedule.</p> <p>In this file you can see how it works. A change is considered failed when an exception is raised. Any exception will stop
the process and flag it as failed. If no exceptions are raised, it means payment has been successful and change can be done.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">declare</span><span class="token punctuation">(</span>strict_types<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token package">AbnDevs<span class="token punctuation">\</span>Subscriptions<span class="token punctuation">\</span>Services</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">AbnDevs<span class="token punctuation">\</span>Subscriptions<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>PlanSubscriptionScheduleService</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">AbnDevs<span class="token punctuation">\</span>Subscriptions<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PlanSubscriptionSchedule</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">function</span> <span class="token package">app</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ScheduleService</span> <span class="token keyword">implements</span> <span class="token class-name">PlanSubscriptionScheduleService</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$planSubscriptionSchedule</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * ScheduleService constructor.
     * Save current Plan Subscription Schedule
     * @param PlanSubscriptionSchedule $planSubscriptionSchedule
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">PlanSubscriptionSchedule</span> <span class="token variable">$planSubscriptionSchedule</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">planSubscriptionSchedule</span> <span class="token operator">=</span> <span class="token variable">$planSubscriptionSchedule</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Execute the strategy
     * Try charging via default payment method and then change plan
     * @throws \Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token variable">$payment</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'laravel-subscriptions.services.payment_methods.'</span> <span class="token operator">.</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">planSubscriptionSchedule</span><span class="token operator">-&gt;</span><span class="token property">subscription</span><span class="token operator">-&gt;</span><span class="token property">payment_method</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$payment</span><span class="token operator">-&gt;</span><span class="token function">charge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">planSubscriptionSchedule</span><span class="token operator">-&gt;</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">planSubscriptionSchedule</span><span class="token operator">-&gt;</span><span class="token function">changeSubscriptionPlan</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre></div><h3 id="service-options"><a href="#service-options" class="header-anchor">#</a> Service options</h3> <p>The defined options for the job that will call the service will be defined in constants the service file. By default,
PlanSubscriptionSchedule contract has this settings.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">const</span> <span class="token constant">TRIES</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// Number of tries job will be attempted</span>
<span class="token keyword">const</span> <span class="token constant">TIMEOUT</span><span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">;</span> <span class="token comment">// Timeout for the job that will launch the service.</span>
</code></pre></div><h2 id="dispatch-the-schedule-job"><a href="#dispatch-the-schedule-job" class="header-anchor">#</a> Dispatch the schedule job</h2> <p>See <a href="/packages/laravel-subscriptions/payments/jobs/subscription-payment-queuer-job.html">Subscription payment queuer job</a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/packages/laravel-subscriptions/models/plan-subscription-feature-model.html" class="prev">
        Plan Subscription Feature Model
      </a></span> <span class="next"><a href="/packages/laravel-subscriptions/payments/payment-services.html">
        Payment services
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.85871902.js" defer></script><script src="/assets/js/2.980f3844.js" defer></script><script src="/assets/js/21.71538835.js" defer></script><script src="/assets/js/3.9f4e4011.js" defer></script>
  </body>
</html>
